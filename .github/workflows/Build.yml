name: Build and Push QingLong Docker Image

on:
  push:
    branches: [ main ]
    paths:
      - 'QingLong/services.json'
      - 'QingLong/notify.py'
      - 'QingLong/front.conf'
      - 'QingLong/docker-entrypoint.sh'
      - 'QingLong/README.md'
      - 'QingLong/Dockerfile'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: ğŸ§¾ æ£€å‡ºä»“åº“ä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ” ç™»å½• GitHub å®¹å™¨æ³¨å†Œè¡¨
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ§± è®¾ç½® Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ“‚ æå– REMOTE_FOLDER å¹¶ç”Ÿæˆæ ‡ç­¾
        id: taginfo
        run: |
          # æå– docker-entrypoint.sh ä¸­çš„ REMOTE_FOLDER å˜é‡ï¼ˆå…¼å®¹æœ‰ç¼©è¿›çš„å†™æ³•ï¼‰
          remote_folder=$(grep -E 'REMOTE_FOLDER\s*=' QingLong/docker-entrypoint.sh | sed -E 's/.*REMOTE_FOLDER\s*=\s*"([^"]*)".*/\1/')

          if [ -z "$remote_folder" ]; then
            echo "âŒ æœªæ‰¾åˆ° REMOTE_FOLDER å˜é‡ï¼Œè¯·æ£€æŸ¥ docker-entrypoint.sh"
            exit 1
          fi

          echo "âœ… æå–çš„ REMOTE_FOLDER: $remote_folder"

          # å°† : å’Œ / æ›¿æ¢ä¸ºå•ä¸ªç‚¹ï¼Œé¿å…éæ³• Docker æ ‡ç­¾
          tag_name=$(echo "$remote_folder" | sed 's/:\/\?/\./g')
          echo "ğŸ”§ è½¬æ¢åçš„æ ‡ç­¾å: $tag_name"

          # è¾“å‡ºç¯å¢ƒå˜é‡
          echo "tag_name=$tag_name" >> "$GITHUB_OUTPUT"
          echo "image_name=ghcr.io/${{ github.repository_owner }}/$tag_name" >> "$GITHUB_OUTPUT"

      - name: ğŸ“¦ æ„å»ºå¹¶æ¨é€ Docker é•œåƒ
        uses: docker/build-push-action@v5
        with:
          context: ./QingLong
          push: true
          tags: |
            ${{ steps.taginfo.outputs.image_name }}:latest
          labels: |
            org.opencontainers.image.source=https://github.com/${{ github.repository }}
            org.opencontainers.image.description=QingLong Docker Image
            org.opencontainers.image.licenses=MIT
          cache-from: type=gha
          cache-to: type=gha,mode=max
