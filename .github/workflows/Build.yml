name: æ„å»ºå¹¶æ¨é€ QingLong é•œåƒ

on:
  push:
    branches: [ main ]
    paths:
      - 'QingLong/services.json'
      - 'QingLong/notify.py'
      - 'QingLong/front.conf'
      - 'QingLong/docker-entrypoint.sh'
      - 'QingLong/README.md'
      - 'QingLong/Dockerfile'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest  # ä½¿ç”¨æœ€æ–° Ubuntu ç¯å¢ƒ

    permissions:
      contents: read         # è¯»å–ä»£ç ä»“åº“æƒé™
      packages: write        # æ¨é€é•œåƒåˆ° GHCR çš„æƒé™

    steps:
      - name: ğŸ§¾ æ£€å‡ºä»“åº“ä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ§ª æå– REMOTE_FOLDER å¹¶ç”Ÿæˆé•œåƒæ ‡ç­¾
        id: vars
        run: |
          # ä» docker-entrypoint.sh ä¸­æå– REMOTE_FOLDER å˜é‡å€¼
          remote_folder=$(grep -E 'REMOTE_FOLDER\s*=' QingLong/docker-entrypoint.sh | sed -E 's/.*REMOTE_FOLDER\s*=\s*"([^"]*)".*/\1/')

          if [ -z "$remote_folder" ]; then
            echo "âŒ æœªæ‰¾åˆ° REMOTE_FOLDER å˜é‡ï¼Œè¯·ç¡®è®¤ docker-entrypoint.sh ä¸­æ˜¯å¦å®šä¹‰äº†è¯¥å˜é‡"
            exit 1
          fi

          echo "âœ… æå–çš„ REMOTE_FOLDER: $remote_folder"

          # æŠŠ REMOTE_FOLDER ä¸­çš„ : æˆ– :/ æ›¿æ¢æˆä¸€ä¸ªç‚¹ï¼Œé¿å…å‡ºç°è¿ç»­ç‚¹å·
          tag_name=$(echo "$remote_folder" | sed 's/:\/\?/\./g')

          echo "ğŸ”§ è½¬æ¢åçš„æ ‡ç­¾å: $tag_name"

          # è¾“å‡ºç¯å¢ƒå˜é‡ä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "TAG_NAME=$tag_name" >> "$GITHUB_OUTPUT"
          echo "IMAGE_NAME=ghcr.io/${{ github.repository_owner }}/$tag_name" >> "$GITHUB_OUTPUT"

      - name: ğŸ” ç™»å½• GitHub å®¹å™¨æ³¨å†Œè¡¨
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ§± è®¾ç½® Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ“¦ æ„å»ºå¹¶æ¨é€ Docker é•œåƒ
        uses: docker/build-push-action@v5
        with:
          context: ./QingLong                          # Dockerfile æ‰€åœ¨ç›®å½•
          push: true                                   # æ„å»ºå®Œæˆåæ¨é€é•œåƒ
          tags: |
            ${{ steps.vars.outputs.IMAGE_NAME }}:latest
          labels: |
            org.opencontainers.image.source=https://github.com/${{ github.repository }}
            org.opencontainers.image.description=QingLong Docker Image
            org.opencontainers.image.licenses=MIT
          cache-from: type=gha
          cache-to: type=gha,mode=max
